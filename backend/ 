var Y=Object.create;var k=Object.defineProperty;var J=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var z=Object.getPrototypeOf,Z=Object.prototype.hasOwnProperty;var tt=(n,e)=>{for(var t in e)k(n,t,{get:e[t],enumerable:!0})},H=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of X(e))!Z.call(n,a)&&a!==t&&k(n,a,{get:()=>e[a],enumerable:!(s=J(e,a))||s.enumerable});return n};var b=(n,e,t)=>(t=n!=null?Y(z(n)):{},H(e||!n||!n.__esModule?k(t,"default",{value:n,enumerable:!0}):t,n)),et=n=>H(k({},"__esModule",{value:!0}),n);var it={};tt(it,{default:()=>T});module.exports=et(it);var F=require("obsidian");var d=require("obsidian"),q={openaiApiKey:"",llmModel:"gpt-4o-mini",backendPort:8765,queryMode:"hybrid",githubReleaseTag:"v0.1.0"},E=class extends d.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Obsidian RAG"}),new d.Setting(e).setName("OpenAI API Key").setDesc("Stored in plain text in your vault's data.json. Keep your vault private.").addText(t=>{t.inputEl.type="password",t.setPlaceholder("sk-...").setValue(this.plugin.settings.openaiApiKey).onChange(async s=>{this.plugin.settings.openaiApiKey=s.trim(),await this.plugin.saveSettings()})}),new d.Setting(e).setName("Model").setDesc("OpenAI model for answering queries. Embeddings always use text-embedding-3-small.").addDropdown(t=>t.addOption("gpt-4o-mini","gpt-4o-mini (fast, cheap)").addOption("gpt-4o","gpt-4o (best quality)").addOption("gpt-4.1-mini","gpt-4.1-mini").setValue(this.plugin.settings.llmModel).onChange(async s=>{this.plugin.settings.llmModel=s,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Retrieval"}),new d.Setting(e).setName("Query mode").setDesc("hybrid = best for most queries  |  local = entity-focused  |  global = theme-focused  |  naive = simple vector search").addDropdown(t=>t.addOption("hybrid","Hybrid (recommended)").addOption("local","Local").addOption("global","Global").addOption("naive","Naive").setValue(this.plugin.settings.queryMode).onChange(async s=>{this.plugin.settings.queryMode=s,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Advanced"}),new d.Setting(e).setName("Backend port").setDesc("Port for the local RAG server. Change only if 8765 is taken.").addText(t=>t.setValue(String(this.plugin.settings.backendPort)).onChange(async s=>{let a=parseInt(s);!isNaN(a)&&a>1024&&a<65536&&(this.plugin.settings.backendPort=a,await this.plugin.saveSettings())})),new d.Setting(e).setName("GitHub release tag").setDesc("Backend binary release to download (e.g. v0.1.0)").addText(t=>t.setValue(this.plugin.settings.githubReleaseTag).onChange(async s=>{this.plugin.settings.githubReleaseTag=s.trim(),await this.plugin.saveSettings()}))}};var c=require("obsidian"),N=require("child_process"),w=b(require("path")),h=b(require("fs")),V=b(require("net")),st="YOUR_ORG",nt="obsidian-rag";function j(){return process.platform==="darwin"?"obsidian-rag-backend-macos":process.platform==="win32"?"obsidian-rag-backend-windows.exe":"obsidian-rag-backend-linux"}function at(n){return new Promise(e=>{let t=V.createServer();t.once("error",()=>e(!0)),t.once("listening",()=>{t.close(),e(!1)}),t.listen(n,"127.0.0.1")})}function U(n){return new Promise(e=>setTimeout(e,n))}var R=class{constructor(e,t,s,a){this.app=e;this.settings=t;this.ragClient=s;this.vaultPath=a;this.process=null;this.restartAttempts=0;this.maxRestarts=3;this.healthCheckInterval=null}get binDir(){return w.join(this.vaultPath,".obsidian-rag","bin")}get binaryPath(){return w.join(this.binDir,j())}async start(){if(!h.existsSync(this.binaryPath)&&!await this.promptDownload()){new c.Notice("RAG: backend binary not found. Chat is disabled.");return}if(await at(this.settings.backendPort)){if(await this.ragClient.healthCheck()){new c.Notice("RAG: backend already running."),this.startHealthMonitor();return}new c.Notice(`RAG: port ${this.settings.backendPort} is in use by another process. Change the port in settings.`);return}this.spawnBackend()}buildCliArgs(){let e=this.settings;return["--vault-path",this.vaultPath,"--openai-key",e.openaiApiKey,"--llm-model",e.llmModel,"--port",String(e.backendPort)]}spawnBackend(){let e=this.buildCliArgs(),t=w.join(this.vaultPath,".obsidian-rag");this.process=(0,N.spawn)(this.binaryPath,e,{cwd:t,stdio:["ignore","pipe","pipe"],detached:!1}),this.process.stdout?.on("data",s=>{console.log(`[RAG Backend] ${s.toString().trim()}`)}),this.process.stderr?.on("data",s=>{console.error(`[RAG Backend ERR] ${s.toString().trim()}`)}),this.process.on("exit",(s,a)=>{console.log(`[RAG Backend] exited code=${s} signal=${a}`),this.process=null,this.stopHealthMonitor(),this.restartAttempts<this.maxRestarts&&s!==0&&s!==null?(this.restartAttempts++,new c.Notice(`RAG: backend crashed. Restarting (${this.restartAttempts}/${this.maxRestarts})\u2026`),setTimeout(()=>this.spawnBackend(),3e3)):this.restartAttempts>=this.maxRestarts&&new c.Notice("RAG: backend failed to start after 3 attempts. Check console for errors.")}),this.waitForHealthy(2e4).then(s=>{s?(new c.Notice("RAG: backend ready."),this.restartAttempts=0,this.startHealthMonitor()):new c.Notice("RAG: backend did not respond within 20s. Check console.")})}async waitForHealthy(e){let t=Date.now()+e;for(;Date.now()<t;){if(await this.ragClient.healthCheck())return!0;await U(500)}return!1}startHealthMonitor(){this.healthCheckInterval=setInterval(async()=>{await this.ragClient.healthCheck()||(console.warn("[RAG Backend] health check failed"),this.stopHealthMonitor())},3e4)}stopHealthMonitor(){this.healthCheckInterval!==null&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null)}async stop(){this.stopHealthMonitor(),this.process&&(this.process.kill("SIGTERM"),await U(3e3),this.process&&!this.process.killed&&this.process.kill("SIGKILL"),this.process=null)}promptDownload(){return new Promise(e=>{new G(this.app,this.settings,this.binDir,e).open()})}},G=class extends c.Modal{constructor(t,s,a,i){super(t);this.settings=s;this.binDir=a;this.onComplete=i}onOpen(){let{contentEl:t}=this;t.createEl("h2",{text:"Download RAG Backend"}),t.createEl("p",{text:"The RAG backend binary needs to be downloaded once (~80-150 MB). It will be stored inside your vault."}),this.statusEl=t.createEl("p",{text:"Preparing\u2026"});let s=t.createEl("progress");s.max=100,s.value=0,s.style.width="100%",s.style.marginTop="8px",this.progressEl=s,this.download()}async download(){let t=j(),s=this.settings.githubReleaseTag,i=`${`https://github.com/${st}/${nt}/releases/download/${s}`}/${t}`,o=`${i}.sha256`;try{this.statusEl.setText("Fetching checksum\u2026");let{requestUrl:r}=await import("obsidian"),u=(await r({url:o})).text.trim().split(/\s+/)[0].toLowerCase();this.statusEl.setText("Downloading binary\u2026");let m=await fetch(i);if(!m.ok)throw new Error(`HTTP ${m.status} from ${i}`);let v=parseInt(m.headers.get("content-length")??"0"),K=m.body.getReader(),S=[],B=0;for(;;){let{done:l,value:x}=await K.read();if(l)break;S.push(x),B+=x.length,v>0&&(this.progressEl.value=Math.round(B/v*100))}this.statusEl.setText("Verifying checksum\u2026");let W=S.reduce((l,x)=>l+x.length,0),I=new Uint8Array(W),L=0;for(let l of S)I.set(l,L),L+=l.length;let Q=await crypto.subtle.digest("SHA-256",I),O=Array.from(new Uint8Array(Q)).map(l=>l.toString(16).padStart(2,"0")).join("");if(O!==u)throw new Error(`Checksum mismatch.
Expected: ${u}
Got:      ${O}`);this.statusEl.setText("Installing\u2026"),h.mkdirSync(this.binDir,{recursive:!0});let M=w.join(this.binDir,t);if(h.writeFileSync(M,I),process.platform!=="win32"&&h.chmodSync(M,493),process.platform==="darwin")try{let{execSync:l}=await import("child_process");l(`xattr -d com.apple.quarantine "${M}"`,{stdio:"ignore"})}catch{}this.statusEl.setText("Download complete."),this.progressEl.value=100,setTimeout(()=>{this.close(),this.onComplete(!0)},800)}catch(r){let g=r instanceof Error?r.message:String(r);this.statusEl.setText(`Download failed: ${g}`);let u=this.contentEl.createDiv({cls:"modal-button-container"}),m=u.createEl("button",{text:"Retry"});m.onclick=()=>{u.remove(),this.download()};let v=u.createEl("button",{text:"Skip"});v.onclick=()=>{this.close(),this.onComplete(!1)}}}onClose(){this.contentEl.empty()}};var f=require("obsidian"),P=class{constructor(e){this.baseUrl=e}async healthCheck(){try{return(await(0,f.requestUrl)({url:`${this.baseUrl}/health`,method:"GET",throw:!1})).status===200}catch{return!1}}async indexDocuments(e){return(await(0,f.requestUrl)({url:`${this.baseUrl}/index`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),throw:!0})).json}async query(e){return(await(0,f.requestUrl)({url:`${this.baseUrl}/query`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),throw:!0})).json}async clearIndex(){await(0,f.requestUrl)({url:`${this.baseUrl}/index`,method:"DELETE",throw:!0})}async getIndexStatus(){return(await(0,f.requestUrl)({url:`${this.baseUrl}/index/status`,method:"GET",throw:!0})).json}};var A=require("obsidian"),y="obsidian-rag-chat",C=class extends A.ItemView{constructor(t,s){super(t);this.messages=[];this.plugin=s}getViewType(){return y}getDisplayText(){return"RAG Chat"}getIcon(){return"message-circle"}async onOpen(){let t=this.containerEl.children[1];t.empty(),t.addClass("rag-chat-root"),this.messagesEl=t.createDiv({cls:"rag-messages"});let s=t.createDiv({cls:"rag-input-row"});this.inputEl=s.createEl("textarea",{cls:"rag-input",attr:{placeholder:"Ask anything about your vault\u2026 (Enter to send, Shift+Enter for newline)"}}),this.inputEl.rows=3,this.inputEl.addEventListener("keydown",r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),this.send())});let a=t.createDiv({cls:"rag-control-row"}),i=a.createEl("select",{cls:"rag-mode-select"});["hybrid","local","global","naive"].forEach(r=>{let g=i.createEl("option",{text:r,value:r});r===this.plugin.settings.queryMode&&(g.selected=!0)}),i.addEventListener("change",()=>{this.plugin.settings.queryMode=i.value,this.plugin.saveSettings()}),a.createEl("button",{text:"Clear chat",cls:"rag-clear-btn"}).addEventListener("click",()=>{this.messages=[],this.messagesEl.empty()}),this.sendBtn=a.createEl("button",{text:"Send",cls:"rag-send-btn mod-cta"}),this.sendBtn.addEventListener("click",()=>this.send())}async send(){let t=this.inputEl.value.trim();if(!t)return;this.inputEl.value="",this.appendMessage({role:"user",content:t}),this.sendBtn.disabled=!0,this.sendBtn.setText("\u2026");let s=this.messagesEl.createDiv({cls:"rag-message rag-assistant rag-thinking"});s.setText("Thinking\u2026"),s.scrollIntoView({behavior:"smooth"});try{let a=await this.plugin.ragClient.query({question:t,mode:this.plugin.settings.queryMode});s.remove(),this.appendMessage({role:"assistant",content:a.answer})}catch(a){s.remove();let i=a instanceof Error?a.message:String(a);this.appendMessage({role:"assistant",content:`**Error:** ${i}

Is the RAG backend running?`})}finally{this.sendBtn.disabled=!1,this.sendBtn.setText("Send")}}appendMessage(t){this.messages.push(t);let s=this.messagesEl.createDiv({cls:`rag-message rag-${t.role}`});t.role==="assistant"?A.MarkdownRenderer.render(this.app,t.content,s,"",this):s.createEl("p",{text:t.content}),s.scrollIntoView({behavior:"smooth"})}async onClose(){}};var p=require("obsidian"),$=new Set(["md","pdf","docx","doc","xlsx","xls","png","jpg","jpeg","tiff","tif","bmp","webp","txt"]);function _(n){n.addCommand({id:"index-current-file",name:"Index current file",checkCallback:e=>{let t=n.app.workspace.getActiveFile();return!t||!$.has(t.extension.toLowerCase())?!1:(e||D(n,[t]),!0)}}),n.addCommand({id:"index-vault",name:"Index entire vault",callback:()=>{let e=n.app.vault.getFiles().filter(t=>$.has(t.extension.toLowerCase()));D(n,e)}}),n.addCommand({id:"index-current-folder",name:"Index current folder",checkCallback:e=>{let t=n.app.workspace.getActiveFile();if(!t?.parent)return!1;if(!e){let s=t.parent.path,a=n.app.vault.getFiles().filter(i=>i.path.startsWith(s)&&$.has(i.extension.toLowerCase()));D(n,a)}return!0}}),n.addCommand({id:"clear-index",name:"Clear RAG index",callback:async()=>{try{await n.ragClient.clearIndex(),new p.Notice("RAG: index cleared.")}catch{new p.Notice("RAG: failed to clear index. Is the backend running?")}}})}async function D(n,e){if(e.length===0){new p.Notice("RAG: no indexable files found.");return}let t=n.app.vault.adapter.basePath,s=e.map(o=>`${t}/${o.path}`);new p.Notice(`RAG: indexing ${e.length} file(s)\u2026`);try{await n.ragClient.indexDocuments({paths:s,vault_path:t})}catch{new p.Notice("RAG: failed to start indexing. Is the backend running?");return}let a=n.addStatusBarItem(),i=setInterval(async()=>{try{let o=await n.ragClient.getIndexStatus();if(a.setText(`RAG: ${o.indexed}/${o.total}`),!o.running){clearInterval(i),a.remove();let r=o.errors.length;r>0?(new p.Notice(`RAG: indexed ${o.indexed}/${o.total} files (${r} error(s) \u2014 see console).`),o.errors.forEach(g=>console.error(`[RAG] indexing error for ${g.file}: ${g.error}`))):new p.Notice(`RAG: indexed ${o.indexed} file(s) successfully.`)}}catch{clearInterval(i),a.remove()}},2e3)}var T=class extends F.Plugin{async onload(){await this.loadSettings(),this.ragClient=new P(`http://127.0.0.1:${this.settings.backendPort}`),this.backendManager=new R(this.app,this.settings,this.ragClient,this.app.vault.adapter.basePath),this.registerView(y,e=>new C(e,this)),this.addRibbonIcon("message-circle","Open RAG Chat",()=>{this.activateChatView()}),this.addSettingTab(new E(this.app,this)),_(this),this.app.workspace.onLayoutReady(()=>{this.backendManager.start()})}async onunload(){await this.backendManager.stop()}async activateChatView(){let{workspace:e}=this.app,t=e.getLeavesOfType(y);if(t.length>0){e.revealLeaf(t[0]);return}let s=e.getRightLeaf(!1);s&&(await s.setViewState({type:y,active:!0}),e.revealLeaf(s))}async loadSettings(){this.settings=Object.assign({},q,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
